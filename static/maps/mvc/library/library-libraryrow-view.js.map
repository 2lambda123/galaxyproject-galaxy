{"version":3,"sources":["mvc/library/library-libraryrow-view.js"],"names":["define","mod_masthead","mod_utils","mod_toastr","LibraryRowView","Backbone","View","extend","events","click .save_library_btn","click .delete_library_btn","click .undelete_library_btn","edit_mode","upload_library_btn","element_visibility_config","edit_library_btn","permission_library_btn","save_library_btn","cancel_library_btn","initialize","library","this","render","Galaxy","libraryListView","collection","get","$el","data","tmpl","templateRow","prepareButtons","setElement","button_config","show","repaint","$","hide","old_element","replaceWith","find","tooltip","vis_config","delete_library_btn","undelete_library_btn","edit_button_clicked","cancel_library_modification","save_library_modification","libraries","is_changed","new_name","val","length","warning","set","new_description","new_synopsis","row_view","save","patch","success","error","model","response","responseJSON","err_msg","info","delete_library","destroy","add","preferences","remove","undelete_library","url","urlRoot","id","_","template","join"],"mappings":"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","file":"../../../scripts/mvc/library/library-libraryrow-view.js","sourcesContent":["// dependencies\ndefine([\"layout/masthead\", \"utils/utils\", \"libs/toastr\"], function(mod_masthead, mod_utils, mod_toastr) {\n    // galaxy library row view\n    var LibraryRowView = Backbone.View.extend({\n        events: {\n            \"click .edit_library_btn\": \"edit_button_clicked\",\n            \"click .cancel_library_btn\": \"cancel_library_modification\",\n            \"click .save_library_btn\": \"save_library_modification\",\n            \"click .delete_library_btn\": \"delete_library\",\n            \"click .undelete_library_btn\": \"undelete_library\"\n        },\n\n        edit_mode: false,\n\n        element_visibility_config: {\n            upload_library_btn: false,\n            edit_library_btn: false,\n            permission_library_btn: false,\n            save_library_btn: false,\n            cancel_library_btn: false,\n            delete_library_btn: false,\n            undelete_library_btn: false\n        },\n\n        initialize: function(library) {\n            this.render(library);\n        },\n\n        render: function(library) {\n            if (typeof library === \"undefined\") {\n                library = Galaxy.libraries.libraryListView.collection.get(this.$el.data(\"id\"));\n            }\n            this.prepareButtons(library);\n            var tmpl = this.templateRow();\n            this.setElement(\n                tmpl({\n                    library: library,\n                    button_config: this.element_visibility_config,\n                    edit_mode: this.edit_mode\n                })\n            );\n            this.$el.show();\n            return this;\n        },\n\n        repaint: function(library) {\n            /* need to hide manually because of the element removal in setElement\n    invoked in render() */\n            $(\".tooltip\").hide();\n            /* we need to store the old element to be able to replace it with\n    new one */\n            var old_element = this.$el;\n            /* if user canceled the library param is undefined,\n      if user saved and succeeded the updated library is rendered */\n            this.render();\n            old_element.replaceWith(this.$el);\n            /* now we attach new tooltips to the newly created row element */\n            this.$el.find(\"[data-toggle]\").tooltip();\n        },\n\n        /**\n   * Function modifies the visibility of buttons for\n   * the filling of the row template of given library.\n   */\n        prepareButtons: function(library) {\n            var vis_config = this.element_visibility_config;\n\n            if (this.edit_mode === false) {\n                vis_config.save_library_btn = false;\n                vis_config.cancel_library_btn = false;\n                vis_config.delete_library_btn = false;\n                if (library.get(\"deleted\") === true) {\n                    vis_config.undelete_library_btn = true;\n                    vis_config.upload_library_btn = false;\n                    vis_config.edit_library_btn = false;\n                    vis_config.permission_library_btn = false;\n                } else if (library.get(\"deleted\") === false) {\n                    vis_config.save_library_btn = false;\n                    vis_config.cancel_library_btn = false;\n                    vis_config.undelete_library_btn = false;\n                    if (library.get(\"can_user_add\") === true) {\n                        vis_config.upload_library_btn = true;\n                    }\n                    if (library.get(\"can_user_modify\") === true) {\n                        vis_config.edit_library_btn = true;\n                    }\n                    if (library.get(\"can_user_manage\") === true) {\n                        vis_config.permission_library_btn = true;\n                    }\n                }\n            } else if (this.edit_mode === true) {\n                vis_config.upload_library_btn = false;\n                vis_config.edit_library_btn = false;\n                vis_config.permission_library_btn = false;\n                vis_config.save_library_btn = true;\n                vis_config.cancel_library_btn = true;\n                vis_config.delete_library_btn = true;\n                vis_config.undelete_library_btn = false;\n            }\n\n            this.element_visibility_config = vis_config;\n        },\n\n        /* User clicked the 'edit' button on row so we render a new row\n    that allows editing */\n        edit_button_clicked: function() {\n            this.edit_mode = true;\n            this.repaint();\n        },\n\n        /* User clicked the 'cancel' button so we render normal rowView */\n        cancel_library_modification: function() {\n            // mod_toastr.info('Modifications canceled');\n            this.edit_mode = false;\n            this.repaint();\n        },\n\n        save_library_modification: function() {\n            var library = Galaxy.libraries.libraryListView.collection.get(this.$el.data(\"id\"));\n            var is_changed = false;\n\n            var new_name = this.$el.find(\".input_library_name\").val();\n            if (typeof new_name !== \"undefined\" && new_name !== library.get(\"name\")) {\n                if (new_name.length > 2) {\n                    library.set(\"name\", new_name);\n                    is_changed = true;\n                } else {\n                    mod_toastr.warning(\"Library name has to be at least 3 characters long.\");\n                    return;\n                }\n            }\n\n            var new_description = this.$el.find(\".input_library_description\").val();\n            if (typeof new_description !== \"undefined\" && new_description !== library.get(\"description\")) {\n                library.set(\"description\", new_description);\n                is_changed = true;\n            }\n\n            var new_synopsis = this.$el.find(\".input_library_synopsis\").val();\n            if (typeof new_synopsis !== \"undefined\" && new_synopsis !== library.get(\"synopsis\")) {\n                library.set(\"synopsis\", new_synopsis);\n                is_changed = true;\n            }\n\n            if (is_changed) {\n                var row_view = this;\n                library.save(null, {\n                    patch: true,\n                    success: function(library) {\n                        row_view.edit_mode = false;\n                        row_view.repaint(library);\n                        mod_toastr.success(\"Changes to library saved.\");\n                    },\n                    error: function(model, response) {\n                        if (typeof response.responseJSON !== \"undefined\") {\n                            mod_toastr.error(response.responseJSON.err_msg);\n                        } else {\n                            mod_toastr.error(\"An error occured while attempting to update the library.\");\n                        }\n                    }\n                });\n            } else {\n                this.edit_mode = false;\n                this.repaint(library);\n                mod_toastr.info(\"Nothing has changed.\");\n            }\n        },\n\n        delete_library: function() {\n            var library = Galaxy.libraries.libraryListView.collection.get(this.$el.data(\"id\"));\n            var row_view = this;\n            // mark the library deleted\n            library.destroy({\n                success: function(library) {\n                    library.set(\"deleted\", true);\n                    // add the new deleted library back to the collection (Galaxy specialty)\n                    Galaxy.libraries.libraryListView.collection.add(library);\n                    row_view.edit_mode = false;\n                    if (Galaxy.libraries.preferences.get(\"with_deleted\") === false) {\n                        $(\".tooltip\").hide();\n                        row_view.repaint(library);\n                        row_view.$el.remove();\n                    } else if (Galaxy.libraries.preferences.get(\"with_deleted\") === true) {\n                        row_view.repaint(library);\n                    }\n                    mod_toastr.success(\"Library has been marked deleted.\");\n                },\n                error: function(model, response) {\n                    if (typeof response.responseJSON !== \"undefined\") {\n                        mod_toastr.error(response.responseJSON.err_msg);\n                    } else {\n                        mod_toastr.error(\"An error occured during deleting the library.\");\n                    }\n                }\n            });\n        },\n\n        undelete_library: function() {\n            var library = Galaxy.libraries.libraryListView.collection.get(this.$el.data(\"id\"));\n            var row_view = this;\n\n            // mark the library undeleted\n            library.url = library.urlRoot + library.id + \"?undelete=true\";\n            library.destroy({\n                success: function(library) {\n                    // add the newly undeleted library back to the collection\n                    // backbone does not accept changes through destroy, so update it too\n                    library.set(\"deleted\", false);\n                    Galaxy.libraries.libraryListView.collection.add(library);\n                    row_view.edit_mode = false;\n                    row_view.repaint(library);\n                    mod_toastr.success(\"Library has been undeleted.\");\n                },\n                error: function(model, response) {\n                    if (typeof response.responseJSON !== \"undefined\") {\n                        mod_toastr.error(response.responseJSON.err_msg);\n                    } else {\n                        mod_toastr.error(\"An error occured while undeleting the library.\");\n                    }\n                }\n            });\n        },\n\n        templateRow: function() {\n            return _.template(\n                [\n                    '<tr class=\"<% if(library.get(\"deleted\") === true) { print(\"active\") } %>\" style=\"display:none;\" data-id=\"<%- library.get(\"id\") %>\">',\n                    \"<% if(!edit_mode) { %>\",\n                    '<% if(library.get(\"deleted\")) { %>',\n                    '<td style=\"color:grey;\"><%- library.get(\"name\") %></td>',\n                    \"<% } else { %>\",\n                    '<td><a href=\"#folders/<%- library.get(\"root_folder_id\") %>\"><%- library.get(\"name\") %></a></td>',\n                    \"<% } %>\",\n                    '<% if(library.get(\"description\")) { %>',\n                    '<% if( (library.get(\"description\")).length> 80 ) { %>',\n                    '<td data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"<%= _.escape(library.get(\"description\")) %>\"><%= _.escape(library.get(\"description\")).substring(0, 80) + \"...\" %></td>',\n                    \"<% } else { %>\",\n                    '<td><%= _.escape(library.get(\"description\"))%></td>',\n                    \"<% } %>\",\n                    \"<% } else { %>\",\n                    \"<td></td>\",\n                    \"<% } %>\",\n                    '<% if(library.get(\"synopsis\")) { %>',\n                    '<% if( (library.get(\"synopsis\")).length> 120 ) { %>',\n                    '<td data-toggle=\"tooltip\" data-placement=\"bottom\" title=\"<%= _.escape(library.get(\"synopsis\")) %>\"><%= _.escape(library.get(\"synopsis\")).substring(0, 120) + \"...\" %></td>',\n                    \"<% } else { %>\",\n                    '<td><%= _.escape(library.get(\"synopsis\"))%></td>',\n                    \"<% } %>\",\n                    \"<% } else { %>\",\n                    \"<td></td>\",\n                    \"<% } %>\",\n                    \"<% } else if(edit_mode){ %>\",\n                    '<td><textarea rows=\"4\" class=\"form-control input_library_name\" placeholder=\"name\" ><%- library.get(\"name\") %></textarea></td>',\n                    '<td><textarea rows=\"4\" class=\"form-control input_library_description\" placeholder=\"description\" ><%- library.get(\"description\") %></textarea></td>',\n                    '<td><textarea rows=\"4\" class=\"form-control input_library_synopsis\" placeholder=\"synopsis\" ><%- library.get(\"synopsis\") %></textarea></td>',\n                    \"<% } %>\",\n                    '<td class=\"right-center\">',\n                    '<% if( (library.get(\"public\")) && (library.get(\"deleted\") === false) ) { %>',\n                    '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"Unrestricted library\" style=\"color:grey;\" class=\"fa fa-globe fa-lg\"> </span>',\n                    \"<% }%>\",\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Modify \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs edit_library_btn\" type=\"button\" style=\"<% if(button_config.edit_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-pencil\"></span> Edit</button>',\n                    '<a href=\"#library/<%- library.get(\"id\") %>/permissions\"><button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Permissions of \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs permission_library_btn\" type=\"button\" style=\"<% if(button_config.permission_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-group\"></span> Manage</button></a>',\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Save changes\" class=\"primary-button btn-xs save_library_btn\" type=\"button\" style=\"<% if(button_config.save_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-floppy-o\"></span> Save</button>',\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Discard changes\" class=\"primary-button btn-xs cancel_library_btn\" type=\"button\" style=\"<% if(button_config.cancel_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-times\"></span> Cancel</button>',\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Delete \\'<%- library.get(\"name\") %>\\'\" class=\"primary-button btn-xs delete_library_btn\" type=\"button\" style=\"<% if(button_config.delete_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-trash-o\"></span> Delete</button>',\n                    // For deleted libraries\n                    '<span data-toggle=\"tooltip\" data-placement=\"top\" title=\"Marked deleted\" style=\"color:grey; <% if(button_config.undelete_library_btn === false) { print(\"display:none;\") } %>\" class=\"fa fa-ban fa-lg\"></span>',\n                    '<button data-toggle=\"tooltip\" data-placement=\"top\" title=\"Undelete \\'<%- library.get(\"name\") %>\\' \" class=\"primary-button btn-xs undelete_library_btn\" type=\"button\" style=\"<% if(button_config.undelete_library_btn === false) { print(\"display:none;\") } %>\"><span class=\"fa fa-unlock\"></span> Undelete</button>',\n                    \"</td>\",\n                    \"</tr>\"\n                ].join(\"\")\n            );\n        }\n    });\n\n    return {\n        LibraryRowView: LibraryRowView\n    };\n});\n"]}