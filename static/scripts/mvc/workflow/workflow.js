define(["mvc/workflow/workflow-manager","mvc/workflow/workflow-objects"],function(a,b){return Backbone.View.extend({initialize:function(c){function d(){b.workflow.layout(),b.workflow.fit_canvas_to_nodes(),h.scroll_to_nodes(),b.canvas_manager.draw_overview()}function e(){b.workflow.clear_active_node(function(){$(".right-content").hide(),$("#edit-attributes").show()})}function f(){$.jStorage.set("overview-off",!1),$("#overview-border").css("right","0px"),$("#close-viewport").css("background-position","0px 0px")}function g(){$.jStorage.set("overview-off",!0),$("#overview-border").css("right","20000px"),$("#close-viewport").css("background-position","12px 0px")}var h=this;this.options=c,this.urls=c&&c.urls||{},this.active_ajax_call=!1;var i=function(){b.workflow.check_changes_in_active_form(),workflow&&b.workflow.has_changes?(do_close=function(){window.onbeforeunload=void 0,window.document.location=h.urls.workflow_index},show_modal("Close workflow editor","There are unsaved changes to your workflow which will be lost.",{Cancel:hide_modal,"Save Changes":function(){j(null,do_close)}},{"Don't Save":do_close})):window.document.location=h.urls.workflow_index},j=function(a,c){if(show_message("Saving workflow","progress"),b.workflow.check_changes_in_active_form(),!b.workflow.has_changes)return hide_modal(),void(c&&c());b.workflow.rectify_workflow_outputs();var d=function(a){$.ajax({url:h.urls.save_workflow,type:"POST",data:{id:h.options.id,workflow_data:function(){return JSON.stringify(b.workflow.to_simple())},_:"true"},dataType:"json",success:function(c){var d=$("<div></div>").text(c.message);if(c.errors){d.addClass("warningmark");var e=$("<ul/>");$.each(c.errors,function(a,b){$("<li></li>").text(b).appendTo(e)}),d.append(e)}else d.addClass("donemark");b.workflow.name=c.name,b.workflow.has_changes=!1,b.workflow.stored=!0,h.show_workflow_parameters(),c.errors?show_modal("Saving workflow",d,{Ok:hide_modal}):(a&&a(),hide_modal())}})};h.active_ajax_call?$(document).bind("ajaxStop.save_workflow",function(){$(document).unbind("ajaxStop.save_workflow"),d(),$(document).unbind("ajaxStop.save_workflow"),h.active_ajax_call=!1}):d(c)};if(window.lt_ie_7)return void show_modal("Browser not supported","Sorry, the workflow editor is not supported for IE6 and below.");$("#tool-search-query").click(function(){$(this).focus(),$(this).select()}).keyup(function(){if($(this).css("font-style","normal"),this.value.length<3)reset_tool_search(!1);else if(this.value!=this.lastValue){$(this).addClass("search_active");var a=this.value;this.timer&&clearTimeout(this.timer),$("#search-spinner").show(),this.timer=setTimeout(function(){$.get(h.urls.tool_search,{q:a},function(a){if($("#search-no-results").hide(),$(".toolSectionWrapper").hide(),$(".toolSectionWrapper").find(".toolTitle").hide(),0!=a.length){var b=$.map(a,function(a){return"link-"+a});$(b).each(function(a,b){$("[id='"+b+"']").parent().addClass("search_match"),$("[id='"+b+"']").parent().show().parent().parent().show().parent().show()}),$(".toolPanelLabel").each(function(){for(var a=$(this),b=a.next(),c=!0;0!==b.length&&b.hasClass("toolTitle");){if(b.is(":visible")){c=!1;break}b=b.next()}c&&a.hide()})}else $("#search-no-results").show();$("#search-spinner").hide()},"json")},400)}this.lastValue=this.value}),b.canvas_manager=new a.CanvasManager($("#canvas-viewport"),$("#overview")),this.reset(),datatypes=JSON.parse($.ajax({type:"GET",url:galaxy_config.root+"api/datatypes",async:!1}).responseText),$.ajax({url:h.urls.get_datatypes,dataType:"json",cache:!1,success:function(c){a.populate_datatype_info(c),$.ajax({url:h.urls.load_workflow,data:{id:h.options.id,_:"true"},dataType:"json",cache:!1,success:function(a){h.reset(),b.workflow.from_simple(a),b.workflow.has_changes=!1,b.workflow.fit_canvas_to_nodes(),h.scroll_to_nodes(),b.canvas_manager.draw_overview(),upgrade_message="",$.each(a.upgrade_messages,function(a,c){upgrade_message+="<li>Step "+(parseInt(a,10)+1)+": "+b.workflow.nodes[a].name+"<ul>",$.each(c,function(a,b){upgrade_message+="<li>"+b+"</li>"}),upgrade_message+="</ul></li>"}),upgrade_message?show_modal("Workflow loaded with changes","Problems were encountered loading this workflow (possibly a result of tool upgrades). Please review the following parameters and then save.<ul>"+upgrade_message+"</ul>",{Continue:hide_modal}):hide_modal(),h.show_workflow_parameters()},beforeSubmit:function(){show_message("Loading workflow","progress")}})}}),$(document).ajaxStart(function(){h.active_ajax_call=!0,$(document).bind("ajaxStop.global",function(){h.active_ajax_call=!1})}),$(document).ajaxError(function(a,b){var c=b.responseText||b.statusText||"Could not connect to server";return show_modal("Server error",c,{"Ignore error":hide_modal}),!1}),make_popupmenu($("#workflow-options-button"),{Save:j,Run:function(){window.location=h.urls.run_workflow},"Edit Attributes":e,"Auto Re-layout":d,Close:i}),overview_size=$.jStorage.get("overview-size"),void 0!==overview_size&&$("#overview-border").css({width:overview_size,height:overview_size}),$.jStorage.get("overview-off")?g():f(),$("#overview-border").bind("dragend",function(a,b){var c=$(this).offsetParent(),d=c.offset(),e=Math.max(c.width()-(b.offsetX-d.left),c.height()-(b.offsetY-d.top));$.jStorage.set("overview-size",e+"px")}),$("#close-viewport").click(function(){"0px"===$("#overview-border").css("right")?g():f()}),window.onbeforeunload=function(){return workflow&&b.workflow.has_changes?"There are unsaved changes to your workflow which will be lost.":void 0},$("div.toolSectionBody").hide(),$("div.toolSectionTitle > span").wrap("<a href='#'></a>");var k=null;$("div.toolSectionTitle").each(function(){var a=$(this).next("div.toolSectionBody");$(this).click(function(){a.is(":hidden")?(k&&k.slideUp("fast"),k=a,a.slideDown("fast")):(a.slideUp("fast"),k=null)})}),async_save_text("workflow-name","workflow-name",h.urls.rename_async,"new_name"),$("#workflow-tag").click(function(){return $(".tag-area").click(),!1}),async_save_text("workflow-annotation","workflow-annotation",h.urls.annotate_async,"new_annotation",25,!0,4)},reset:function(){b.workflow&&b.workflow.remove_all(),b.workflow=new a.Workflow($("#canvas-container"))},scroll_to_nodes:function(){var a,b,c=$("#canvas-viewport"),d=$("#canvas-container");b=d.width()<c.width()?(c.width()-d.width())/2:0,a=d.height()<c.height()?(c.height()-d.height())/2:0,d.css({left:b,top:a})},add_node_for_tool:function(a,c){node=b.workflow.create_node("tool",c,a),$.ajax({url:this.urls.get_new_module_info,data:{type:"tool",tool_id:a,_:"true"},global:!1,dataType:"json",success:function(a){node.init_field_data(a)},error:function(a){var b="error loading field data";0===a.status&&(b+=", server unavailable"),node.error(b)}})},add_node_for_module:function(a,c){node=b.workflow.create_node(a,c),$.ajax({url:this.urls.get_new_module_info,data:{type:a,_:"true"},dataType:"json",success:function(a){node.init_field_data(a)},error:function(a){var b="error loading field data";0==a.status&&(b+=", server unavailable"),node.error(b)}})},display_pja:function(a,c){$("#pja_container").append(get_pja_form(a,c)),$("#pja_container>.toolForm:last>.toolFormTitle>.buttons").click(function(){action_to_rem=$(this).closest(".toolForm",".action_tag").children(".action_tag:first").text(),$(this).closest(".toolForm").remove(),delete b.workflow.active_node.post_job_actions[action_to_rem],b.workflow.active_form_has_changes=!0})},display_pja_list:function(){return pja_list},display_file_list:function(a){addlist="<select id='node_data_list' name='node_data_list'>";for(var b in a.output_terminals)addlist+="<option value='"+b+"'>"+b+"</option>";return addlist+="</select>",addlist},new_pja:function(a,c,d){if(void 0===d.post_job_actions&&(d.post_job_actions={}),void 0===d.post_job_actions[a+c]){var e={};return e.action_type=a,e.output_name=c,d.post_job_actions[a+c]=null,d.post_job_actions[a+c]=e,display_pja(e,d),b.workflow.active_form_has_changes=!0,!0}return!1},show_workflow_parameters:function(){var a=/\$\{.+?\}/g,c=[],d=$("#workflow-parameters-container"),e=$("#workflow-parameters-box"),f="",g=[];$.each(b.workflow.nodes,function(b,d){var e=d.form_html.match(a);e&&(g=g.concat(e)),d.post_job_actions&&($.each(d.post_job_actions,function(b,c){c.action_arguments&&$.each(c.action_arguments,function(b,c){var d=c.match(a);d&&(g=g.concat(d))})}),g&&$.each(g,function(a,b){-1===$.inArray(b,c)&&c.push(b)}))}),c&&0!==c.length?($.each(c,function(a,b){f+="<div>"+b.substring(2,b.length-1)+"</div>"}),d.html(f),e.show()):(d.html(f),e.hide())}})});
//# sourceMappingURL=../../../maps/mvc/workflow/workflow.js.map